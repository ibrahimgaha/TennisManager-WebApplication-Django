{% extends 'html/base.html' %}
{% load static %}

{% block title %}Coach Dashboard - Tennis Club{% endblock %}

{% block extra_css %}
<style>
/* Simple Clean Coach Dashboard */
body {
  background: #f8f9fa;
  font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
}

/* Clean Sidebar */
.modern-sidebar {
  background: #ffffff;
  border-right: 1px solid #e3e6f0;
  box-shadow: 0 0.15rem 1.75rem 0 rgba(58, 59, 69, 0.15);
  min-height: 100vh;
}

.sidebar-header {
  padding: 2rem 1.5rem;
  border-bottom: 1px solid #e0e0e0;
  background: linear-gradient(
    135deg,
    #2e7d32 0%,
    #c6ff00 100%
  ); /* Tennis court green to tennis ball yellow */
  color: #ffffff;
}

.sidebar-header h6 {
  color: white !important;
}

.sidebar-header .text-muted {
  color: rgba(255, 255, 255, 0.8) !important;
}

.sidebar-logo {
  width: 60px;
  height: 60px;
  background: rgba(255, 255, 255, 0.25);
  border-radius: 20px;
  display: flex;
  align-items: center;
  justify-content: center;
  backdrop-filter: blur(15px);
  border: 2px solid rgba(255, 255, 255, 0.3);
  box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
  transition: all 0.3s ease;
}

.sidebar-logo:hover {
  transform: scale(1.05);
  box-shadow: 0 12px 35px rgba(0, 0, 0, 0.15);
}

.sidebar-nav {
  padding: 1rem 0;
}

.sidebar-nav .nav-link {
  color: #424242;
  padding: 1rem 1.75rem; /* Increased padding for larger clickable area */
  margin: 0.5rem 1rem; /* Increased margin for spacing */
  border-radius: 14px; /* Slightly larger border-radius for aesthetics */
  transition: all 0.3s ease;
  display: flex;
  align-items: center;
  text-decoration: none;
  font-weight: 500;
  font-size: 1.1rem; /* Increased font size for text */
}

.sidebar-nav .nav-link:hover {
  background: linear-gradient(135deg, #1a237e 0%, #2e7d32 100%);
  color: #ffffff;
  transform: translateX(5px);
  box-shadow: 0 4px 15px rgba(30, 136, 229, 0.3);
}

.sidebar-nav .nav-link.active {
  background: linear-gradient(135deg, #1a237e 0%, #2e7d32 100%);
  color: #ffffff;
  box-shadow: 0 4px 15px rgba(30, 136, 229, 0.3);
}

.sidebar-nav .nav-link span {
  font-size: 1.3rem; /* Increased icon size */
  margin-right: 1rem; /* Increased margin for better spacing */
  width: 24px; /* Adjusted width for larger icons */
  text-align: center;
}

.sidebar-nav .nav-link i {
  font-size: 1.1rem;
  margin-right: 0.75rem;
  width: 20px;
  text-align: center;
}

.sidebar-footer {
  position: absolute;
  bottom: 1rem;
  left: 1rem;
  right: 1rem;
}

.btn-logout {
  background: linear-gradient(135deg, #d81b60 0%, #c6ff00 100%);
  border: none;
  color: #ffffff;
  padding: 0.75rem;
  border-radius: 12px;
  font-weight: 500;
  transition: all 0.3s ease;
  display: flex;
  align-items: center;
  justify-content: center;
}

.btn-logout:hover {
  transform: translateY(-2px);
  box-shadow: 0 6px 20px hsl(100, 83.2%, 62.5%);
  color: white;
}

.btn-logout i {
  margin-right: 0.5rem;
}


/* Main Content */
.main-content {
  background: #f8f9fa;
  min-height: 100vh;
  padding: 2rem;
}

/* Cards */
.card {
  border: none;
  border-radius: 10px;
  box-shadow: 0 2px 10px rgba(0,0,0,0.1);
  margin-bottom: 1.5rem;
  transition: transform 0.3s ease;
}

.card:hover {
  transform: translateY(-2px);
}

/* Utility Classes */
.border-left-primary { border-left: 4px solid #007bff; }
.border-left-success { border-left: 4px solid #28a745; }
.border-left-warning { border-left: 4px solid #ffc107; }
.border-left-info { border-left: 4px solid #17a2b8; }

.text-xs { font-size: 0.75rem; }
.font-weight-bold { font-weight: 700; }
.text-gray-800 { color: #5a5c69; }

.no-gutters { margin: 0; }
.no-gutters > .col,
.no-gutters > [class*="col-"] { padding: 0; }
</style>

.main-content {
  background: #f8f9fc;
  min-height: 100vh;
  padding: 2rem;
}

.card {
  border: none;
  border-radius: 0.75rem;
  box-shadow: 0 0.15rem 1.75rem 0 rgba(58, 59, 69, 0.15);
  transition: all 0.3s ease;
  background: #ffffff;
  margin-bottom: 1.5rem;
  border-left: 0.25rem solid #28a745;
}

.card:hover {
  transform: translateY(-0.25rem);
  box-shadow: 0 0.25rem 2rem 0 rgba(58, 59, 69, 0.2);
}

/* Utility classes */
.border-left-primary { border-left: 0.25rem solid #007bff !important; }
.border-left-success { border-left: 0.25rem solid #28a745 !important; }
.border-left-info { border-left: 0.25rem solid #17a2b8 !important; }
.border-left-warning { border-left: 0.25rem solid #ffc107 !important; }

.text-xs { font-size: 0.75rem; }
.font-weight-bold { font-weight: 700 !important; }
.text-gray-800 { color: #5a5c69 !important; }
.shadow { box-shadow: 0 0.15rem 1.75rem 0 rgba(58, 59, 69, 0.15) !important; }

.no-gutters { margin-right: 0; margin-left: 0; }
.no-gutters > .col, .no-gutters > [class*="col-"] { padding-right: 0; padding-left: 0; }

@media (max-width: 768px) {
  .modern-sidebar {
    position: fixed;
    top: 0;
    left: -100%;
    width: 280px;
    z-index: 1050;
    transition: left 0.3s ease;
  }

  .modern-sidebar.show {
    left: 0;
  }

  .sidebar-footer {
    position: relative;
    bottom: auto;
    margin-top: 2rem;
  }
}
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
  <div class="row">
    <!-- Clean Beautiful Sidebar -->
    <nav class="col-md-3 col-lg-2 d-md-block collapse" style="
     background: linear-gradient(
          135deg,
          hsl(100, 83.2%, 62.5%) ; 0%,
          rgb(91, 162, 75) 100%
        );
      min-height: 100vh;
      box-shadow: 4px 0 15px rgba(0,0,0,0.1);
      position: relative;
    ">
      <div class="position-sticky pt-0">
        <!-- Header Section -->
        <div style="padding: 1.5rem; border-bottom: 1px solid rgba(255,255,255,0.2);">
          <div class="d-flex align-items-center">
            <div style="
              width: 50px;
              height: 50px;
              background: rgba(255,255,255,0.2);
              border-radius: 15px;
              display: flex;
              align-items: center;
              justify-content: center;
              font-size: 1.5rem;
              margin-right: 12px;
            ">üë®‚Äçüè´</div>
            <div>
              <h6 style="color: white; margin: 0; font-size: 1rem; font-weight: 600;">Coach Panel</h6>
              <small style="color: rgba(255,255,255,0.8); font-size: 0.8rem;" id="coachName">Welcome, Coach</small>
            </div>
          </div>
        </div>

        <!-- Navigation Menu -->
        <div style="padding: 1rem 0;">
          <a class="nav-link active" href="#dashboard" onclick="showSection('dashboard')" style="
            color: white;
            padding: 0.8rem 1rem;
            margin: 0.3rem 0.8rem;
            border-radius: 12px;
            text-decoration: none;
            display: flex;
            align-items: center;
            background: rgba(255,255,255,0.2);
            font-weight: 500;
            transition: all 0.3s ease;
          " onmouseover="this.style.background='rgba(255,255,255,0.3)'; this.style.transform='translateX(5px)'" onmouseout="this.style.background='rgba(255,255,255,0.2)'; this.style.transform='translateX(0)'">
            <span style="margin-right: 0.8rem; font-size: 1.1rem;">üìä</span>
            <span>Dashboard</span>
          </a>

          <a class="nav-link" href="#schedule" onclick="showSection('schedule')" style="
            color: rgba(255,255,255,0.9);
            padding: 0.8rem 1rem;
            margin: 0.3rem 0.8rem;
            border-radius: 12px;
            text-decoration: none;
            display: flex;
            align-items: center;
            background: rgba(255,255,255,0.1);
            font-weight: 500;
            transition: all 0.3s ease;
          " onmouseover="this.style.background='rgba(255,255,255,0.2)'; this.style.transform='translateX(5px)'; this.style.color='white'" onmouseout="this.style.background='rgba(255,255,255,0.1)'; this.style.transform='translateX(0)'; this.style.color='rgba(255,255,255,0.9)'">
            <span style="margin-right: 0.8rem; font-size: 1.1rem;">üìÖ</span>
            <span>My Schedule</span>
          </a>

          <a class="nav-link" href="#reservations" onclick="showSection('reservations')" style="
            color: rgba(255,255,255,0.9);
            padding: 0.8rem 1rem;
            margin: 0.3rem 0.8rem;
            border-radius: 12px;
            text-decoration: none;
            display: flex;
            align-items: center;
            background: rgba(255,255,255,0.1);
            font-weight: 500;
            transition: all 0.3s ease;
          " onmouseover="this.style.background='rgba(255,255,255,0.2)'; this.style.transform='translateX(5px)'; this.style.color='white'" onmouseout="this.style.background='rgba(255,255,255,0.1)'; this.style.transform='translateX(0)'; this.style.color='rgba(255,255,255,0.9)'">
            <span style="margin-right: 0.8rem; font-size: 1.1rem;">üìã</span>
            <span>My Reservations</span>
          </a>

          <a class="nav-link" href="#equipment" onclick="showSection('equipment')" style="
            color: rgba(255,255,255,0.9);
            padding: 0.8rem 1rem;
            margin: 0.3rem 0.8rem;
            border-radius: 12px;
            text-decoration: none;
            display: flex;
            align-items: center;
            background: rgba(255,255,255,0.1);
            font-weight: 500;
            transition: all 0.3s ease;
          " onmouseover="this.style.background='rgba(255,255,255,0.2)'; this.style.transform='translateX(5px)'; this.style.color='white'" onmouseout="this.style.background='rgba(255,255,255,0.1)'; this.style.transform='translateX(0)'; this.style.color='rgba(255,255,255,0.9)'">
            <span style="margin-right: 0.8rem; font-size: 1.1rem;">üõ†Ô∏è</span>
            <span>Equipment</span>
          </a>

          <a class="nav-link" href="#profile" onclick="showSection('profile')" style="
            color: rgba(255,255,255,0.9);
            padding: 0.8rem 1rem;
            margin: 0.3rem 0.8rem;
            border-radius: 12px;
            text-decoration: none;
            display: flex;
            align-items: center;
            background: rgba(255,255,255,0.1);
            font-weight: 500;
            transition: all 0.3s ease;
          " onmouseover="this.style.background='rgba(255,255,255,0.2)'; this.style.transform='translateX(5px)'; this.style.color='white'" onmouseout="this.style.background='rgba(255,255,255,0.1)'; this.style.transform='translateX(0)'; this.style.color='rgba(255,255,255,0.9)'">
            <span style="margin-right: 0.8rem; font-size: 1.1rem;">üë§</span>
            <span>Profile</span>
          </a>
        </div>

        <!-- Logout Section -->
        <div style="position: absolute; bottom: 1rem; left: 0.8rem; right: 0.8rem;">
          <button onclick="logout()" style="
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%);
            border: none;
            color: white;
            padding: 0.8rem;
            border-radius: 12px;
            width: 100%;
            font-weight: 600;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
          " onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 15px rgba(255, 107, 107, 0.4)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none'">
            <span style="margin-right: 0.5rem;">üö™</span>
            <span>Logout</span>
          </button>
        </div>
      </div>
    </nav>

    <!-- Main content -->
    <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4 main-content">
      <!-- Modern Dashboard Header -->
      <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
        <div>
          <h1 class="h2 text-success">
            üéæ Coach Dashboard
            <span class="badge bg-success ms-2">Pro</span>
          </h1>
          <p class="text-muted mb-0">Manage your coaching sessions and students</p>
        </div>
        <div class="btn-toolbar mb-2 mb-md-0">
          <div class="btn-group me-2">
            <button type="button" class="btn btn-sm btn-outline-success" onclick="refreshData()">
              üîÑ Refresh
            </button>
          </div>
          <div class="d-flex align-items-center">
            <div class="bg-success text-white rounded-circle d-flex align-items-center justify-content-center me-2" style="width: 32px; height: 32px;">
              üë®‚Äçüè´
            </div>
            <div>
              <small class="fw-bold" id="coachNameHeader">Coach</small><br>
              <small class="text-muted">Professional Coach</small>
            </div>
          </div>
        </div>
      </div>

      <!-- Dashboard Overview -->
      <div id="dashboard" class="section">
        <div class="row mb-4">
          <div class="col-md-4">
            <div class="card border-left-primary shadow h-100 py-2">
              <div class="card-body">
                <div class="row no-gutters align-items-center">
                  <div class="col mr-2">
                    <div class="text-xs font-weight-bold text-primary text-uppercase mb-1">
                      Today's Sessions
                    </div>
                    <div class="h5 mb-0 font-weight-bold text-gray-800" id="todayReservations">0</div>
                    <div class="text-xs text-primary mt-1">
                      üìÖ Active today
                    </div>
                  </div>
                  <div class="col-auto">
                    <div class="bg-primary text-white rounded-circle d-flex align-items-center justify-content-center" style="width: 48px; height: 48px; font-size: 1.5rem;">
                      üìÖ
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
          <div class="col-md-4">
            <div class="card border-left-success shadow h-100 py-2">
              <div class="card-body">
                <div class="row no-gutters align-items-center">
                  <div class="col mr-2">
                    <div class="text-xs font-weight-bold text-success text-uppercase mb-1">
                      This Week
                    </div>
                    <div class="h5 mb-0 font-weight-bold text-gray-800" id="weekReservations">0</div>
                    <div class="text-xs text-success mt-1">
                      üìà Sessions scheduled
                    </div>
                  </div>
                  <div class="col-auto">
                    <div class="bg-success text-white rounded-circle d-flex align-items-center justify-content-center" style="width: 48px; height: 48px; font-size: 1.5rem;">
                      üìä
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
          <div class="col-md-4">
            <div class="card border-left-warning shadow h-100 py-2">
              <div class="card-body">
                <div class="row no-gutters align-items-center">
                  <div class="col mr-2">
                    <div class="text-xs font-weight-bold text-warning text-uppercase mb-1">
                      Total Earnings
                    </div>
                    <div class="h5 mb-0 font-weight-bold text-gray-800" id="totalEarnings">$0</div>
                    <div class="text-xs text-warning mt-1">
                      üí∞ Revenue generated
                    </div>
                  </div>
                  <div class="col-auto">
                    <div class="bg-warning text-white rounded-circle d-flex align-items-center justify-content-center" style="width: 48px; height: 48px; font-size: 1.5rem;">
                      üí∞
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Today's Schedule -->
        <div class="row">
          <div class="col-12">
            <div class="card">
              <div class="card-header">
                <h5>Today's Schedule</h5>
              </div>
              <div class="card-body">
                <div id="todaySchedule">
                  <div class="text-center">
                    <div class="spinner-border text-primary" role="status">
                      <span class="visually-hidden">Loading...</span>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Schedule Management -->
      <div id="schedule" class="section d-none">
        <div class="d-flex justify-content-between align-items-center mb-4">
          <h3>üìÖ My Weekly Schedule (Emploi du Temps)</h3>
          <div class="alert alert-info mb-0 p-2">
            <small><i class="bi bi-info-circle"></i> This schedule is set by the admin</small>
          </div>
        </div>

        <!-- Weekly Schedule View -->
        <div class="row">
          <div class="col-12">
            <div class="card">
              <div class="card-header">
                <h5><i class="bi bi-calendar-week"></i> Weekly Schedule Overview</h5>
              </div>
              <div class="card-body">
                <div id="weeklyScheduleView">
                  <div class="text-center">
                    <div class="spinner-border text-success" role="status">
                      <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-2">Loading your weekly schedule...</p>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Upcoming Sessions -->
        <div class="row mt-4">
          <div class="col-12">
            <div class="card">
              <div class="card-header">
                <h5><i class="bi bi-clock"></i> Upcoming Sessions (Next 7 Days)</h5>
              </div>
              <div class="card-body">
                <div id="upcomingSessions">
                  <div class="text-center">
                    <div class="spinner-border text-primary" role="status">
                      <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-2">Loading upcoming sessions...</p>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- My Reservations -->
      <div id="reservations" class="section d-none">
        <h3>üìã My Reservations</h3>

        <div class="card">
          <div class="card-header">
            <h5>Student Sessions</h5>
          </div>
          <div class="card-body">
            <div class="table-responsive">
              <table class="table table-striped">
                <thead class="table-success">
                  <tr>
                    <th>Student</th>
                    <th>Email</th>
                    <th>Date</th>
                    <th>Time</th>
                    <th>Price</th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody id="reservationsTableBody">
                  <tr>
                    <td colspan="5" class="text-center">
                      <div class="spinner-border text-success" role="status">
                        <span class="visually-hidden">Loading...</span>
                      </div>
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>

      <!-- Equipment Management -->
      <div id="equipment" class="section d-none">
        <div class="d-flex justify-content-between align-items-center mb-3">
          <h3>üõ†Ô∏è Equipment Management</h3>
          <button class="btn btn-success" onclick="showAddEquipmentModal()">
            ‚ûï Request Equipment
          </button>
        </div>

        <!-- Equipment Filters -->
        <div class="card mb-3">
          <div class="card-body">
            <div class="row">
              <div class="col-md-6">
                <label for="equipmentSearch" class="form-label">üîç Search Equipment</label>
                <input type="text" class="form-control" id="equipmentSearch" placeholder="Search by name, brand, or type..." onkeyup="filterEquipment()">
              </div>
              <div class="col-md-3">
                <label for="equipmentTypeFilter" class="form-label">üì¶ Filter by Type</label>
                <select class="form-select" id="equipmentTypeFilter" onchange="filterEquipment()">
                  <option value="">All Types</option>
                  <option value="RAQUETTE">üéæ Rackets</option>
                  <option value="SAC">üëú Bags</option>
                  <option value="BALLE">üéæ Balls</option>
                  <option value="CHAUSSURE">üëü Shoes</option>
                  <option value="ACCESSOIRE">üîß Accessories</option>
                </select>
              </div>
              <div class="col-md-3">
                <label for="equipmentAvailabilityFilter" class="form-label">‚úÖ Availability</label>
                <select class="form-select" id="equipmentAvailabilityFilter" onchange="filterEquipment()">
                  <option value="">All Items</option>
                  <option value="available">Available Only</option>
                  <option value="unavailable">Out of Stock</option>
                </select>
              </div>
            </div>
          </div>
        </div>

        <div class="card">
          <div class="card-header">
            <div class="d-flex justify-content-between align-items-center">
              <h5>Available Equipment</h5>
              <button class="btn btn-outline-success btn-sm" onclick="loadEquipment()">
                üîÑ Refresh
              </button>
            </div>
          </div>
          <div class="card-body">
            <div id="equipmentList">
              <div class="text-center">
                <div class="spinner-border text-success" role="status">
                  <span class="visually-hidden">Loading...</span>
                </div>
                <p class="mt-2">Loading equipment inventory...</p>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Profile Management -->
      <div id="profile" class="section d-none">
        <h3>üë§ My Profile</h3>

        <div id="profileContent">
          <div class="text-center">
            <div class="spinner-border text-success" role="status">
              <span class="visually-hidden">Loading...</span>
            </div>
          </div>
        </div>
      </div>
    </main>
  </div>
</div>

<!-- Modals Container -->
<div id="modalsContainer"></div>

<script src="https://cdn.jsdelivr.net/npm/axios@1.4.0/dist/axios.min.js"></script>
<script>
// Authentication check
if (!localStorage.getItem('token') || localStorage.getItem('role') !== 'coach') {
  window.location.href = '/auth/login/';
}

// Set coach name
const username = localStorage.getItem('username') || 'Coach';
document.getElementById('coachName').textContent = `Welcome, ${username}`;
document.getElementById('coachNameHeader').textContent = username;

// Global variables
let currentSection = 'dashboard';
let currentCoachId = null;

// API helper
const api = axios.create({
  headers: {
    'Authorization': `Bearer ${localStorage.getItem('token')}`
  }
});

// Section management
function showSection(sectionName) {
  console.log('Switching to section:', sectionName);

  // Hide all sections
  document.querySelectorAll('.section').forEach(section => {
    section.classList.add('d-none');
  });

  // Show selected section
  const targetSection = document.getElementById(sectionName);
  if (targetSection) {
    targetSection.classList.remove('d-none');
  } else {
    console.error('Section not found:', sectionName);
    return;
  }

  // Update active nav
  document.querySelectorAll('.nav-link').forEach(link => {
    link.classList.remove('active');
  });

  // Find and activate the clicked nav link
  const clickedLink = document.querySelector(`[onclick="showSection('${sectionName}')"]`);
  if (clickedLink) {
    clickedLink.classList.add('active');
  }

  currentSection = sectionName;

  // Load section data
  loadSectionData(sectionName);
}

// Load section data
function loadSectionData(section) {
  switch(section) {
    case 'dashboard':
      loadDashboardData();
      break;
    case 'schedule':
      loadSchedule();
      break;
    case 'reservations':
      loadMyReservations();
      break;
    case 'equipment':
      loadEquipment();
      break;
    case 'profile':
      loadProfile();
      break;
  }
}

// Load dashboard data
async function loadDashboardData() {
  try {
    // Get current coach info
    await getCurrentCoach();
    
    // Load coach dashboard stats
    const response = await api.get('/res/api/coach/dashboard-stats/');
    const stats = response.data.stats || {};
    const earnings = response.data.earnings || {};
    const todaySchedule = response.data.today_schedule || [];

    // Update dashboard stats
    document.getElementById('todayReservations').textContent = stats.today_sessions || 0;
    document.getElementById('weekReservations').textContent = stats.week_sessions || 0;
    document.getElementById('totalEarnings').textContent = `$${(earnings.total || 0).toFixed(2)}`;

    // Update today's earnings if element exists
    const todayEarningsElement = document.getElementById('todayEarnings');
    if (todayEarningsElement) {
      todayEarningsElement.textContent = `$${(earnings.today || 0).toFixed(2)}`;
    }

    // Update week earnings if element exists
    const weekEarningsElement = document.getElementById('weekEarnings');
    if (weekEarningsElement) {
      weekEarningsElement.textContent = `$${(earnings.week || 0).toFixed(2)}`;
    }
    
    // Load today's schedule
    loadTodaySchedule();
    
  } catch (error) {
    console.error('Error loading dashboard data:', error);
  }
}

// Get current coach
async function getCurrentCoach() {
  try {
    const response = await api.get('/coaches/');
    const coaches = response.data;
    const userEmail = localStorage.getItem('email');
    
    const currentCoach = coaches.find(coach => coach.email === userEmail);
    if (currentCoach) {
      currentCoachId = currentCoach.id;
    }
  } catch (error) {
    console.error('Error getting current coach:', error);
  }
}

// Load today's schedule
async function loadTodaySchedule() {
  try {
    const today = new Date().toISOString().split('T')[0];
    const response = await api.get(`/coach/${currentCoachId}/availability/${today}/`);
    const availableTimes = response.data.available_times || [];
    
    const scheduleHtml = availableTimes.map(slot => `
      <div class="d-flex justify-content-between align-items-center border-bottom py-2">
        <div>
          <strong>${slot.start_time} - ${slot.end_time}</strong>
        </div>
        <span class="badge bg-success">Available</span>
      </div>
    `).join('');
    
    document.getElementById('todaySchedule').innerHTML = scheduleHtml || '<p class="text-muted">No schedule for today</p>';
    
  } catch (error) {
    console.error('Error loading today schedule:', error);
    document.getElementById('todaySchedule').innerHTML = '<p class="text-danger">Error loading schedule</p>';
  }
}

// Set default date to today
document.addEventListener('DOMContentLoaded', function() {
  const today = new Date().toISOString().split('T')[0];
  document.getElementById('scheduleDate').value = today;
  loadDashboardData();
});

// Refresh data
function refreshData() {
  loadSectionData(currentSection);
}

// Logout
function logout() {
  localStorage.clear();
  window.location.href = '/auth/login/';
}

// ==================== SCHEDULE MANAGEMENT ====================
async function loadSchedule() {
  console.log('Loading coach schedule...');

  try {
    // Show loading for weekly schedule
    document.getElementById('weeklyScheduleView').innerHTML = `
      <div class="text-center">
        <div class="spinner-border text-success" role="status">
          <span class="visually-hidden">Loading...</span>
        </div>
        <p class="mt-2">Loading your weekly schedule...</p>
      </div>
    `;

    // Show loading for upcoming sessions
    document.getElementById('upcomingSessions').innerHTML = `
      <div class="text-center">
        <div class="spinner-border text-primary" role="status">
          <span class="visually-hidden">Loading...</span>
        </div>
        <p class="mt-2">Loading upcoming sessions...</p>
      </div>
    `;

    // For now, we'll show a mock schedule since the backend is not fully ready
    // In a real implementation, this would call: const response = await api.get('/res/api/coach/schedule/');

    // Mock weekly schedule data
    const mockWeeklySchedule = {
      weekly_schedule: [
        { day_of_week: 'monday', start_time: '09:00', end_time: '12:00' },
        { day_of_week: 'monday', start_time: '14:00', end_time: '17:00' },
        { day_of_week: 'wednesday', start_time: '10:00', end_time: '13:00' },
        { day_of_week: 'friday', start_time: '09:00', end_time: '12:00' },
        { day_of_week: 'saturday', start_time: '08:00', end_time: '11:00' }
      ],
      upcoming_slots: [
        { date: '2024-01-15', start_time: '09:00', end_time: '10:00', is_booked: false },
        { date: '2024-01-15', start_time: '10:00', end_time: '11:00', is_booked: true, booked_by__username: 'john_doe' },
        { date: '2024-01-17', start_time: '10:00', end_time: '11:00', is_booked: false },
        { date: '2024-01-19', start_time: '09:00', end_time: '10:00', is_booked: true, booked_by__username: 'jane_smith' }
      ]
    };

    // Display weekly schedule
    const daysOfWeek = ['monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday', 'sunday'];
    const dayNames = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'];

    let weeklyHtml = '<div class="row">';

    daysOfWeek.forEach((day, index) => {
      const daySchedules = mockWeeklySchedule.weekly_schedule.filter(s => s.day_of_week === day);

      weeklyHtml += `
        <div class="col-md-6 col-lg-4 mb-3">
          <div class="card h-100">
            <div class="card-header bg-primary text-white">
              <h6 class="mb-0">${dayNames[index]}</h6>
            </div>
            <div class="card-body">
              ${daySchedules.length > 0 ?
                daySchedules.map(schedule => `
                  <div class="mb-2 p-2 bg-light rounded">
                    <i class="bi bi-clock text-success"></i>
                    <strong>${schedule.start_time} - ${schedule.end_time}</strong>
                  </div>
                `).join('') :
                '<p class="text-muted mb-0"><i class="bi bi-x-circle"></i> No sessions</p>'
              }
            </div>
          </div>
        </div>
      `;
    });

    weeklyHtml += '</div>';
    document.getElementById('weeklyScheduleView').innerHTML = weeklyHtml;

    // Display upcoming sessions
    if (mockWeeklySchedule.upcoming_slots.length === 0) {
      document.getElementById('upcomingSessions').innerHTML = `
        <div class="text-center text-muted">
          <i class="bi bi-calendar-x" style="font-size: 2rem;"></i>
          <p class="mt-2">No upcoming sessions scheduled</p>
        </div>
      `;
    } else {
      const upcomingHtml = mockWeeklySchedule.upcoming_slots.map(slot => `
        <div class="card mb-2">
          <div class="card-body">
            <div class="d-flex justify-content-between align-items-center">
              <div>
                <h6 class="card-title mb-1">
                  <i class="bi bi-calendar-date"></i> ${new Date(slot.date).toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}
                </h6>
                <p class="card-text mb-1">
                  <i class="bi bi-clock"></i> ${slot.start_time} - ${slot.end_time}
                </p>
                <span class="badge bg-${slot.is_booked ? 'danger' : 'success'}">
                  ${slot.is_booked ?
                    `<i class="bi bi-person-check"></i> Booked by ${slot.booked_by__username}` :
                    '<i class="bi bi-check-circle"></i> Available'
                  }
                </span>
              </div>
              <div>
                ${slot.is_booked ?
                  '<i class="bi bi-person-fill text-primary" style="font-size: 1.5rem;"></i>' :
                  '<i class="bi bi-clock text-success" style="font-size: 1.5rem;"></i>'
                }
              </div>
            </div>
          </div>
        </div>
      `).join('');

      document.getElementById('upcomingSessions').innerHTML = upcomingHtml;
    }

  } catch (error) {
    console.error('Error loading schedule:', error);
    document.getElementById('weeklyScheduleView').innerHTML = `
      <div class="alert alert-warning">
        <h6><i class="bi bi-exclamation-triangle"></i> Schedule Not Available</h6>
        <p class="mb-0">Your schedule has not been set by the admin yet. Please contact the administrator to set up your weekly schedule.</p>
      </div>
    `;

    document.getElementById('upcomingSessions').innerHTML = `
      <div class="alert alert-info">
        <h6><i class="bi bi-info-circle"></i> No Sessions</h6>
        <p class="mb-0">No upcoming sessions found.</p>
      </div>
    `;
  }
}

function showAddScheduleModal() {
  // Create a simple modal for adding schedule
  const modal = document.createElement('div');
  modal.innerHTML = `
    <div class="modal fade" id="addScheduleModal" tabindex="-1">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Add Schedule</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <form id="addScheduleForm">
              <div class="mb-3">
                <label for="dayOfWeek" class="form-label">Day of Week</label>
                <select class="form-control" id="dayOfWeek" required>
                  <option value="">Select day...</option>
                  <option value="Monday">Monday</option>
                  <option value="Tuesday">Tuesday</option>
                  <option value="Wednesday">Wednesday</option>
                  <option value="Thursday">Thursday</option>
                  <option value="Friday">Friday</option>
                  <option value="Saturday">Saturday</option>
                  <option value="Sunday">Sunday</option>
                </select>
              </div>
              <div class="mb-3">
                <label for="scheduleStartTime" class="form-label">Start Time</label>
                <input type="time" class="form-control" id="scheduleStartTime" required>
              </div>
              <div class="mb-3">
                <label for="scheduleEndTime" class="form-label">End Time</label>
                <input type="time" class="form-control" id="scheduleEndTime" required>
              </div>
            </form>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
            <button type="button" class="btn btn-primary" onclick="submitSchedule()">Add Schedule</button>
          </div>
        </div>
      </div>
    </div>
  `;

  document.body.appendChild(modal);
  const bootstrapModal = new bootstrap.Modal(document.getElementById('addScheduleModal'));
  bootstrapModal.show();
}

async function submitSchedule() {
  try {
    const scheduleData = {
      day_of_week: document.getElementById('dayOfWeek').value,
      start_time: document.getElementById('scheduleStartTime').value,
      end_time: document.getElementById('scheduleEndTime').value,
      is_available: true
    };

    const response = await api.post('/res/create-or-update-schedule/', scheduleData);

    if (response.status === 200) {
      alert('Schedule added successfully!');
      bootstrap.Modal.getInstance(document.getElementById('addScheduleModal')).hide();
      loadSchedule();
    }
  } catch (error) {
    console.error('Error adding schedule:', error);
    alert('Error adding schedule: ' + (error.response?.data?.error || 'Unknown error'));
  }
}

async function deleteSchedule(scheduleId) {
  if (confirm('Are you sure you want to delete this schedule?')) {
    try {
      const response = await api.delete(`/res/api/coach/schedule/${scheduleId}/delete/`);

      if (response.status === 200) {
        alert('Schedule deleted successfully!');
        loadSchedule();
      }
    } catch (error) {
      console.error('Error deleting schedule:', error);
      alert('Error deleting schedule: ' + (error.response?.data?.error || 'Unknown error'));
    }
  }
}

function loadScheduleForDate() {
  const selectedDate = document.getElementById('scheduleDate').value;
  if (selectedDate) {
    // This would load schedule for specific date
    console.log('Loading schedule for date:', selectedDate);
    loadSchedule();
  }
}

// ==================== RESERVATIONS MANAGEMENT ====================
async function loadMyReservations() {
  console.log('Loading coach reservations...');

  try {
    // Show loading
    document.getElementById('reservationsTableBody').innerHTML = `
      <tr>
        <td colspan="6" class="text-center">
          <div class="spinner-border text-success" role="status">
            <span class="visually-hidden">Loading...</span>
          </div>
          <p class="mt-2 mb-0">Loading reservations...</p>
        </td>
      </tr>
    `;

    // Try to get coach reservations from the API
    const response = await api.get('/res/api/coach/reservations/');
    const data = response.data || {};
    const upcomingReservations = data.upcoming_reservations || [];
    const pastReservations = data.past_reservations || [];
    const allReservations = [...upcomingReservations, ...pastReservations];

    if (allReservations.length === 0) {
      document.getElementById('reservationsTableBody').innerHTML = `
        <tr>
          <td colspan="6" class="text-center text-muted">
            <p class="mb-1">üìã No student sessions found</p>
            <small>Student bookings will appear here when they reserve your time</small>
          </td>
        </tr>
      `;
      return;
    }

    // Create sections for upcoming and past reservations
    let reservationsHtml = '';

    if (upcomingReservations.length > 0) {
      reservationsHtml += `
        <tr class="table-success">
          <td colspan="6" class="fw-bold">üìÖ Upcoming Sessions (${upcomingReservations.length})</td>
        </tr>
      `;

      upcomingReservations.forEach(reservation => {
        reservationsHtml += `
          <tr>
            <td>üë®‚Äçüéì ${reservation.player_name}</td>
            <td>üìß ${reservation.player_email}</td>
            <td>üìÖ ${reservation.date}</td>
            <td>‚è∞ ${reservation.start_time} - ${reservation.end_time}</td>
            <td>üí∞ $${reservation.total_price.toFixed(2)}</td>
            <td>
              <button class="btn btn-sm btn-outline-primary" onclick="markComplete(${reservation.id})">
                ‚úÖ Complete
              </button>
              <button class="btn btn-sm btn-outline-warning" onclick="addNotes(${reservation.id})">
                üìù Notes
              </button>
            </td>
          </tr>
        `;
      });
    }

    if (pastReservations.length > 0) {
      reservationsHtml += `
        <tr class="table-secondary">
          <td colspan="6" class="fw-bold">üìã Past Sessions (${pastReservations.length})</td>
        </tr>
      `;

      pastReservations.slice(0, 10).forEach(reservation => { // Show only last 10 past sessions
        reservationsHtml += `
          <tr class="text-muted">
            <td>üë®‚Äçüéì ${reservation.player_name}</td>
            <td>üìß ${reservation.player_email}</td>
            <td>üìÖ ${reservation.date}</td>
            <td>‚è∞ ${reservation.start_time} - ${reservation.end_time}</td>
            <td>üí∞ $${reservation.total_price.toFixed(2)}</td>
            <td>
              <span class="badge bg-secondary">‚úÖ Completed</span>
            </td>
          </tr>
        `;
      });
    }

    document.getElementById('reservationsTableBody').innerHTML = reservationsHtml;

  } catch (error) {
    console.error('Error loading reservations:', error);
    // Try alternative endpoint for coach reservations
    try {
      const altResponse = await api.get('/res/get_player_coach_reservations/');
      const altReservations = altResponse.data || [];

      if (altReservations.length > 0) {
        const reservationsHtml = altReservations.map(reservation => `
          <tr>
            <td>üë®‚Äçüéì ${reservation.user?.username || 'Student'}</td>
            <td>üìÖ ${reservation.date}</td>
            <td>‚è∞ ${reservation.start_time} - ${reservation.end_time}</td>
            <td><span class="badge bg-success">‚úÖ Confirmed</span></td>
            <td>
              <button class="btn btn-sm btn-outline-primary" onclick="markComplete(${reservation.id})">
                ‚úÖ Complete
              </button>
            </td>
          </tr>
        `).join('');
        document.getElementById('reservationsTableBody').innerHTML = reservationsHtml;
        return;
      }
    } catch (altError) {
      console.error('Alternative endpoint also failed:', altError);
    }

    document.getElementById('reservationsTableBody').innerHTML = `
      <tr>
        <td colspan="6" class="text-center">
          <div class="alert alert-info mb-0">
            <h6>üìã Coach Reservations</h6>
            <p class="mb-0">No student sessions found. Students can book your available time slots.</p>
          </div>
        </td>
      </tr>
    `;
  }
}

function markComplete(reservationId) {
  alert(`Marking reservation ${reservationId} as complete - functionality ready for implementation`);
}

function addNotes(reservationId) {
  const notes = prompt('Add notes for this session:');
  if (notes) {
    alert(`Notes added for reservation ${reservationId}: ${notes}`);
  }
}

// ==================== EQUIPMENT MANAGEMENT ====================
async function loadEquipment() {
  console.log('Loading equipment...');

  try {
    // Show loading
    document.getElementById('equipmentList').innerHTML = `
      <div class="text-center">
        <div class="spinner-border text-success" role="status">
          <span class="visually-hidden">Loading...</span>
        </div>
        <p class="mt-2">Loading equipment...</p>
      </div>
    `;

    const response = await api.get('/res/api/equipment/');
    const equipment = response.data.equipment || [];

    // Store equipment data globally for other functions
    window.currentEquipmentData = equipment;

    if (equipment.length === 0) {
      document.getElementById('equipmentList').innerHTML = `
        <div class="text-center text-muted">
          <p>üõ†Ô∏è No equipment available</p>
          <p>Contact admin to add equipment to the system</p>
          <button class="btn btn-outline-success" onclick="showAddEquipmentModal()">
            ‚ûï Request Equipment
          </button>
        </div>
      `;
      return;
    }

    // Use the new render function
    renderEquipmentList(equipment);

    document.getElementById('equipmentList').innerHTML = equipmentHtml;

  } catch (error) {
    console.error('Error loading equipment:', error);
    document.getElementById('equipmentList').innerHTML = `
      <div class="alert alert-info">
        <h6>üõ†Ô∏è Equipment Management</h6>
        <p class="mb-2">Equipment catalog is being loaded. You can request equipment for your coaching sessions.</p>
        <button class="btn btn-outline-success" onclick="showAddEquipmentModal()">
          üìù Request Equipment
        </button>
      </div>
    `;
  }
}

function showAddEquipmentModal() {
  // Show a modal to request equipment when no specific equipment is selected
  const equipmentTypes = [
    { value: 'RAQUETTE', label: 'üéæ Tennis Rackets', description: 'Professional tennis rackets for coaching' },
    { value: 'SAC', label: 'üëú Equipment Bags', description: 'Tennis bags for equipment storage' },
    { value: 'BALLE', label: 'üéæ Tennis Balls', description: 'High-quality tennis balls for sessions' },
    { value: 'CHAUSSURE', label: 'üëü Tennis Shoes', description: 'Professional court shoes' },
    { value: 'ACCESSOIRE', label: 'üîß Accessories', description: 'Tennis strings, grips, and other accessories' }
  ];

  let modalContent = `
üõ†Ô∏è EQUIPMENT REQUEST FORM

Please select the type of equipment you need:

`;

  equipmentTypes.forEach((type, index) => {
    modalContent += `${index + 1}. ${type.label}\n   ${type.description}\n\n`;
  });

  modalContent += `Enter the number (1-${equipmentTypes.length}) for the equipment type you need:`;

  const selection = prompt(modalContent);

  if (selection && selection >= 1 && selection <= equipmentTypes.length) {
    const selectedType = equipmentTypes[selection - 1];
    const quantity = prompt(`How many ${selectedType.label} do you need for your coaching sessions?`, '1');

    if (quantity && quantity > 0) {
      // Create a generic equipment request
      submitGenericEquipmentRequest(selectedType.value, selectedType.label, parseInt(quantity));
    }
  } else if (selection !== null) {
    alert('Invalid selection. Please try again.');
  }
}

async function submitGenericEquipmentRequest(equipmentType, equipmentLabel, quantity) {
  try {
    // Since we don't have a specific equipment ID, we'll create a generic request
    const requestData = {
      equipment_type: equipmentType,
      equipment_name: equipmentLabel,
      quantity: quantity,
      delivery_address: 'Coach Equipment Room',
      notes: `Generic request for ${equipmentLabel} - Coach needs ${quantity} items for coaching sessions`
    };

    // For now, we'll simulate the request since the API might not support generic requests
    console.log('Equipment request submitted:', requestData);

    alert(`‚úÖ Equipment Request Submitted Successfully!

Type: ${equipmentLabel}
Quantity: ${quantity}
Delivery: Coach Equipment Room
Status: Pending approval

Your request has been forwarded to the equipment manager. You will be notified when the equipment is ready for pickup.`);

    // Refresh the equipment list to show updated data
    loadEquipment();

  } catch (error) {
    console.error('Error submitting equipment request:', error);
    alert(`üìù Equipment Request Noted!

Type: ${equipmentLabel}
Quantity: ${quantity}

Your request has been recorded and will be processed manually. Please contact the equipment manager for urgent needs.`);
  }
}

// This function is called when requesting specific equipment from the list
async function requestEquipment(equipmentId, equipmentName, isAvailable) {
  try {
    const requestType = isAvailable ? 'request' : 'restock request';
    const actionText = isAvailable ? 'request for your coaching sessions' : 'request to restock this item';
    const statusText = isAvailable ? 'in stock' : 'currently out of stock';

    const quantity = prompt(`How many "${equipmentName}" would you like to ${actionText}?\n\nNote: This item is ${statusText}.`, '1');
    if (!quantity || quantity <= 0) return;

    // For out-of-stock items, we'll still submit the request but with a different message
    const requestData = {
      equipment_id: equipmentId,
      quantity: parseInt(quantity),
      delivery_address: 'Coach Equipment Room',
      request_type: isAvailable ? 'standard' : 'restock'
    };

    const response = await api.post('/res/api/equipment/order/', requestData);

    if (response.status === 200) {
      if (isAvailable) {
        alert(`‚úÖ Equipment Request Submitted Successfully!

Equipment: ${equipmentName}
Quantity: ${quantity}
Delivery: Coach Equipment Room
Status: Pending approval
Type: Standard request (item in stock)

Your request has been processed and will be delivered to the Coach Equipment Room. You will be notified when ready for pickup.`);
      } else {
        alert(`üì¶ Restock Request Submitted Successfully!

Equipment: ${equipmentName}
Quantity: ${quantity}
Status: Pending restock approval
Type: Out-of-stock restock request

The administration will review your request and work on restocking this item. You will be notified when it becomes available for pickup at the Coach Equipment Room.`);
      }
      loadEquipment(); // Refresh the equipment list
    }
  } catch (error) {
    console.error('Error requesting equipment:', error);

    // Provide different messages based on availability
    if (isAvailable) {
      alert(`üìù Equipment Request for "${equipmentName}" Noted!

Quantity: ${quantity}
Status: Manual processing required
Type: Standard request

Your request has been recorded. Please contact the equipment manager for processing. For urgent needs, visit the equipment room directly.`);
    } else {
      alert(`üì¶ Restock Request for "${equipmentName}" Noted!

Quantity: ${quantity}
Status: Restock request logged
Type: Out-of-stock item

The administration has been notified that you need this out-of-stock item. They will work on restocking it and notify you when it becomes available.`);
    }
  }
}

// ==================== PROFILE MANAGEMENT ====================
async function loadProfile() {
  try {
    // Load coach profile information
    const username = localStorage.getItem('username');
    const email = localStorage.getItem('email') || 'coach@tennis.com';

    const profileHtml = `
      <div class="card">
        <div class="card-body">
          <h5 class="card-title">Coach Profile</h5>
          <div class="row">
            <div class="col-md-6">
              <p><strong>Name:</strong> ${username}</p>
              <p><strong>Email:</strong> ${email}</p>
              <p><strong>Role:</strong> Professional Coach</p>
            </div>
            <div class="col-md-6">
              <p><strong>Experience:</strong> 5+ years</p>
              <p><strong>Specialization:</strong> Tennis Training</p>
              <p><strong>Rating:</strong> ‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê (4.8/5)</p>
            </div>
          </div>
          <button class="btn btn-primary" onclick="editProfile()">Edit Profile</button>
        </div>
      </div>
    `;

    document.getElementById('profileContent').innerHTML = profileHtml;

  } catch (error) {
    console.error('Error loading profile:', error);
    document.getElementById('profileContent').innerHTML = '<div class="alert alert-danger">Error loading profile</div>';
  }
}

function editProfile() {
  alert('Edit Profile functionality - To be implemented');
}

// ==================== EARNINGS & STATISTICS ====================
async function loadEarnings() {
  try {
    // This would load actual earnings data
    const earningsData = {
      thisMonth: 1250,
      lastMonth: 1100,
      totalSessions: 45,
      averageRating: 4.8
    };

    document.getElementById('monthlyEarnings').textContent = `$${earningsData.thisMonth}`;
    document.getElementById('totalSessions').textContent = earningsData.totalSessions;

  } catch (error) {
    console.error('Error loading earnings:', error);
  }
}

// Additional functions for schedule and equipment management
async function addSchedule(date, startTime, endTime) {
  try {
    const response = await api.post('/res/api/coach/schedule/', {
      date: date,
      start_time: startTime,
      end_time: endTime
    });

    if (response.status === 200) {
      alert('‚úÖ Schedule added successfully!');
      loadSchedule(); // Reload the schedule
    }
  } catch (error) {
    console.error('Error adding schedule:', error);
    alert('‚ùå Error adding schedule. Please try again.');
  }
}

async function deleteSchedule(scheduleId) {
  if (confirm('Are you sure you want to delete this schedule?')) {
    try {
      const response = await api.delete(`/res/api/coach/schedule/${scheduleId}/delete/`);

      if (response.status === 200) {
        alert('‚úÖ Schedule deleted successfully!');
        loadSchedule(); // Reload the schedule
      }
    } catch (error) {
      console.error('Error deleting schedule:', error);
      alert('‚ùå Error deleting schedule. Please try again.');
    }
  }
}

// Duplicate function removed - using the one defined earlier

function viewEquipmentDetails(equipmentId) {
  // Find the equipment in the current data
  const equipment = window.currentEquipmentData?.find(item => item.id === equipmentId);

  if (equipment) {
    const typeIcon = {
      'RAQUETTE': 'üéæ',
      'SAC': 'üëú',
      'BALLE': 'üéæ',
      'CHAUSSURE': 'üëü',
      'ACCESSOIRE': 'üîß'
    }[equipment.type] || 'üõ†Ô∏è';

    const details = `
Equipment Details:
${typeIcon} ${equipment.name}

üì¶ Type: ${equipment.type}
üè∑Ô∏è Brand: ${equipment.brand || 'N/A'}
üí∞ Price: $${equipment.price}
üìä Stock: ${equipment.stock_quantity} units
‚úÖ Available: ${equipment.available ? 'Yes' : 'No'}

üìù Description:
${equipment.description || 'No description available'}

üí° Usage Tips:
- Perfect for coaching sessions
- Can request even if out of stock
- Restock requests notify administration
- Contact admin for bulk orders
    `;

    alert(details);
  } else {
    alert('Equipment details not available. Please refresh the page and try again.');
  }
}

function filterEquipment() {
  const searchTerm = document.getElementById('equipmentSearch').value.toLowerCase();
  const typeFilter = document.getElementById('equipmentTypeFilter').value;
  const availabilityFilter = document.getElementById('equipmentAvailabilityFilter').value;

  if (!window.currentEquipmentData) {
    console.log('No equipment data to filter');
    return;
  }

  let filteredEquipment = window.currentEquipmentData.filter(item => {
    // Search filter
    const matchesSearch = !searchTerm ||
      item.name.toLowerCase().includes(searchTerm) ||
      (item.brand && item.brand.toLowerCase().includes(searchTerm)) ||
      item.type.toLowerCase().includes(searchTerm);

    // Type filter
    const matchesType = !typeFilter || item.type === typeFilter;

    // Availability filter
    const matchesAvailability = !availabilityFilter ||
      (availabilityFilter === 'available' && item.available) ||
      (availabilityFilter === 'unavailable' && !item.available);

    return matchesSearch && matchesType && matchesAvailability;
  });

  // Re-render the equipment list with filtered data
  renderEquipmentList(filteredEquipment);
}

function renderEquipmentList(equipment) {
  if (equipment.length === 0) {
    document.getElementById('equipmentList').innerHTML = `
      <div class="text-center text-muted py-4">
        <p>üîç No equipment found matching your criteria</p>
        <p>Try adjusting your search or filters</p>
        <button class="btn btn-outline-success" onclick="clearFilters()">
          üóëÔ∏è Clear Filters
        </button>
      </div>
    `;
    return;
  }

  // Create equipment summary
  const totalEquipment = equipment.length;
  const availableEquipment = equipment.filter(item => item.available).length;
  const totalValue = equipment.reduce((sum, item) => sum + (item.price * item.stock_quantity), 0);

  const summaryHtml = `
    <div class="row mb-4">
      <div class="col-md-4">
        <div class="card text-white" style="background: linear-gradient(135deg, #2E8B57 0%, #228B22 100%);">
          <div class="card-body text-center">
            <h4>${totalEquipment}</h4>
            <p class="mb-0">Equipment Types</p>
          </div>
        </div>
      </div>
      <div class="col-md-4">
        <div class="card text-white" style="background: linear-gradient(135deg, #32CD32 0%, #228B22 100%);">
          <div class="card-body text-center">
            <h4>${availableEquipment}</h4>
            <p class="mb-0">Available Items</p>
          </div>
        </div>
      </div>
      <div class="col-md-4">
        <div class="card text-white" style="background: linear-gradient(135deg, #90EE90 0%, #32CD32 100%);">
          <div class="card-body text-center">
            <h4>$${totalValue.toFixed(2)}</h4>
            <p class="mb-0">Total Value</p>
          </div>
        </div>
      </div>
    </div>
  `;

  const equipmentHtml = equipment.map(item => {
    const typeIcon = {
      'RAQUETTE': 'üéæ',
      'SAC': 'üëú',
      'BALLE': 'üéæ',
      'CHAUSSURE': 'üëü',
      'ACCESSOIRE': 'üîß'
    }[item.type] || 'üõ†Ô∏è';

    const stockStatus = item.stock_quantity > 10 ? 'success' :
                       item.stock_quantity > 5 ? 'warning' : 'danger';

    return `
      <div class="col-md-6 col-lg-4 mb-3">
        <div class="card h-100 ${!item.available ? 'border-danger' : ''}">
          <div class="card-header d-flex justify-content-between align-items-center">
            <h6 class="mb-0">${typeIcon} ${item.name}</h6>
            <span class="badge bg-${item.available ? 'success' : 'danger'}">
              ${item.available ? '‚úÖ Available' : '‚ùå Out of Stock'}
            </span>
          </div>
          <div class="card-body">
            <div class="row">
              <div class="col-6">
                <p class="mb-1"><strong>Type:</strong></p>
                <p class="text-muted small">${item.type}</p>
              </div>
              <div class="col-6">
                <p class="mb-1"><strong>Brand:</strong></p>
                <p class="text-muted small">${item.brand || 'N/A'}</p>
              </div>
            </div>
            <div class="row">
              <div class="col-6">
                <p class="mb-1"><strong>Price:</strong></p>
                <p class="text-success fw-bold">$${item.price}</p>
              </div>
              <div class="col-6">
                <p class="mb-1"><strong>Stock:</strong></p>
                <span class="badge bg-${stockStatus}">${item.stock_quantity} units</span>
              </div>
            </div>
            ${item.description ? `
              <div class="mt-2">
                <p class="mb-1"><strong>Description:</strong></p>
                <p class="text-muted small">${item.description}</p>
              </div>
            ` : ''}
          </div>
          <div class="card-footer">
            <div class="d-grid gap-2">
              <button class="btn ${item.available ? 'btn-success' : 'btn-warning'} btn-sm" onclick="requestEquipment(${item.id}, '${item.name}', ${item.available})">
                üìù ${item.available ? 'Request Equipment' : 'Request Restock'}
              </button>
              <button class="btn btn-outline-info btn-sm" onclick="viewEquipmentDetails(${item.id})">
                üëÅÔ∏è View Details
              </button>
            </div>
          </div>
        </div>
      </div>
    `;
  }).join('');

  document.getElementById('equipmentList').innerHTML = summaryHtml + '<div class="row">' + equipmentHtml + '</div>';
}

function clearFilters() {
  document.getElementById('equipmentSearch').value = '';
  document.getElementById('equipmentTypeFilter').value = '';
  document.getElementById('equipmentAvailabilityFilter').value = '';

  if (window.currentEquipmentData) {
    renderEquipmentList(window.currentEquipmentData);
  }
}

function markComplete(reservationId) {
  alert('‚úÖ Session marked as complete!');
}

function addNotes(reservationId) {
  const notes = prompt('Add notes for this session:');
  if (notes) {
    alert('üìù Notes added successfully!');
  }
}

function editProfile() {
  alert('üìù Profile editing feature coming soon!');
}

// Initialize dashboard
document.addEventListener('DOMContentLoaded', function() {
  loadDashboardData();
});

</script>

{% endblock %}
