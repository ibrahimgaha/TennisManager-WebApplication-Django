{% extends 'html/base.html' %}
{% load static %}

{% block title %}Coach Dashboard - Tennis Club{% endblock %}

{% block extra_css %}
<style>
/* Simple Clean Coach Dashboard */
body {
  background: #f8f9fa;
  font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
}

/* Clean Sidebar */
.modern-sidebar {
  background: #ffffff;
  border-right: 1px solid #dee2e6;
  box-shadow: 0 0 10px rgba(0,0,0,0.1);
  min-height: 100vh;
}

.sidebar-header {
  padding: 1.5rem;
  background: linear-gradient(135deg, #28a745, #20c997);
  color: white;
  border-bottom: 1px solid #dee2e6;
}

.sidebar-logo {
  width: 50px;
  height: 50px;
  background: rgba(255,255,255,0.2);
  border-radius: 10px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 1.5rem;
  margin-bottom: 1rem;
}

.sidebar-nav {
  padding: 1rem 0;
  list-style: none;
  margin: 0;
}

.sidebar-nav .nav-link {
  color: #6c757d;
  padding: 0.75rem 1.5rem;
  margin: 0.25rem 1rem;
  border-radius: 8px;
  text-decoration: none;
  display: flex;
  align-items: center;
  transition: all 0.3s ease;
}

.sidebar-nav .nav-link:hover,
.sidebar-nav .nav-link.active {
  background: linear-gradient(135deg, #28a745, #20c997);
  color: white;
  transform: translateX(5px);
}

.nav-icon {
  margin-right: 0.75rem;
  font-size: 1.1rem;
  width: 20px;
  text-align: center;
}

.btn-logout {
  background: #dc3545;
  border: none;
  color: white;
  padding: 0.75rem;
  border-radius: 8px;
  width: 100%;
  margin: 1rem;
  transition: all 0.3s ease;
}

.btn-logout:hover {
  background: #c82333;
  transform: translateY(-2px);
}

/* Main Content */
.main-content {
  background: #f8f9fa;
  min-height: 100vh;
  padding: 2rem;
}

/* Cards */
.card {
  border: none;
  border-radius: 10px;
  box-shadow: 0 2px 10px rgba(0,0,0,0.1);
  margin-bottom: 1.5rem;
  transition: transform 0.3s ease;
}

.card:hover {
  transform: translateY(-2px);
}

/* Utility Classes */
.border-left-primary { border-left: 4px solid #007bff; }
.border-left-success { border-left: 4px solid #28a745; }
.border-left-warning { border-left: 4px solid #ffc107; }
.border-left-info { border-left: 4px solid #17a2b8; }

.text-xs { font-size: 0.75rem; }
.font-weight-bold { font-weight: 700; }
.text-gray-800 { color: #5a5c69; }

.no-gutters { margin: 0; }
.no-gutters > .col,
.no-gutters > [class*="col-"] { padding: 0; }
</style>

.main-content {
  background: #f8f9fc;
  min-height: 100vh;
  padding: 2rem;
}

.card {
  border: none;
  border-radius: 0.75rem;
  box-shadow: 0 0.15rem 1.75rem 0 rgba(58, 59, 69, 0.15);
  transition: all 0.3s ease;
  background: #ffffff;
  margin-bottom: 1.5rem;
  border-left: 0.25rem solid #28a745;
}

.card:hover {
  transform: translateY(-0.25rem);
  box-shadow: 0 0.25rem 2rem 0 rgba(58, 59, 69, 0.2);
}

/* Utility classes */
.border-left-primary { border-left: 0.25rem solid #007bff !important; }
.border-left-success { border-left: 0.25rem solid #28a745 !important; }
.border-left-info { border-left: 0.25rem solid #17a2b8 !important; }
.border-left-warning { border-left: 0.25rem solid #ffc107 !important; }

.text-xs { font-size: 0.75rem; }
.font-weight-bold { font-weight: 700 !important; }
.text-gray-800 { color: #5a5c69 !important; }
.shadow { box-shadow: 0 0.15rem 1.75rem 0 rgba(58, 59, 69, 0.15) !important; }

.no-gutters { margin-right: 0; margin-left: 0; }
.no-gutters > .col, .no-gutters > [class*="col-"] { padding-right: 0; padding-left: 0; }

@media (max-width: 768px) {
  .modern-sidebar {
    position: fixed;
    top: 0;
    left: -100%;
    width: 280px;
    z-index: 1050;
    transition: left 0.3s ease;
  }

  .modern-sidebar.show {
    left: 0;
  }

  .sidebar-footer {
    position: relative;
    bottom: auto;
    margin-top: 2rem;
  }
}
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
  <div class="row">
    <!-- Clean Beautiful Sidebar -->
    <nav class="col-md-3 col-lg-2 d-md-block collapse" style="
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      box-shadow: 4px 0 15px rgba(0,0,0,0.1);
      position: relative;
    ">
      <div class="position-sticky pt-0">
        <!-- Header Section -->
        <div style="padding: 1.5rem; border-bottom: 1px solid rgba(255,255,255,0.2);">
          <div class="d-flex align-items-center">
            <div style="
              width: 50px;
              height: 50px;
              background: rgba(255,255,255,0.2);
              border-radius: 15px;
              display: flex;
              align-items: center;
              justify-content: center;
              font-size: 1.5rem;
              margin-right: 12px;
            ">üë®‚Äçüè´</div>
            <div>
              <h6 style="color: white; margin: 0; font-size: 1rem; font-weight: 600;">Coach Panel</h6>
              <small style="color: rgba(255,255,255,0.8); font-size: 0.8rem;" id="coachName">Welcome, Coach</small>
            </div>
          </div>
        </div>

        <!-- Navigation Menu -->
        <div style="padding: 1rem 0;">
          <a class="nav-link active" href="#dashboard" onclick="showSection('dashboard')" style="
            color: white;
            padding: 0.8rem 1rem;
            margin: 0.3rem 0.8rem;
            border-radius: 12px;
            text-decoration: none;
            display: flex;
            align-items: center;
            background: rgba(255,255,255,0.2);
            font-weight: 500;
            transition: all 0.3s ease;
          " onmouseover="this.style.background='rgba(255,255,255,0.3)'; this.style.transform='translateX(5px)'" onmouseout="this.style.background='rgba(255,255,255,0.2)'; this.style.transform='translateX(0)'">
            <span style="margin-right: 0.8rem; font-size: 1.1rem;">üìä</span>
            <span>Dashboard</span>
          </a>

          <a class="nav-link" href="#schedule" onclick="showSection('schedule')" style="
            color: rgba(255,255,255,0.9);
            padding: 0.8rem 1rem;
            margin: 0.3rem 0.8rem;
            border-radius: 12px;
            text-decoration: none;
            display: flex;
            align-items: center;
            background: rgba(255,255,255,0.1);
            font-weight: 500;
            transition: all 0.3s ease;
          " onmouseover="this.style.background='rgba(255,255,255,0.2)'; this.style.transform='translateX(5px)'; this.style.color='white'" onmouseout="this.style.background='rgba(255,255,255,0.1)'; this.style.transform='translateX(0)'; this.style.color='rgba(255,255,255,0.9)'">
            <span style="margin-right: 0.8rem; font-size: 1.1rem;">üìÖ</span>
            <span>My Schedule</span>
          </a>

          <a class="nav-link" href="#reservations" onclick="showSection('reservations')" style="
            color: rgba(255,255,255,0.9);
            padding: 0.8rem 1rem;
            margin: 0.3rem 0.8rem;
            border-radius: 12px;
            text-decoration: none;
            display: flex;
            align-items: center;
            background: rgba(255,255,255,0.1);
            font-weight: 500;
            transition: all 0.3s ease;
          " onmouseover="this.style.background='rgba(255,255,255,0.2)'; this.style.transform='translateX(5px)'; this.style.color='white'" onmouseout="this.style.background='rgba(255,255,255,0.1)'; this.style.transform='translateX(0)'; this.style.color='rgba(255,255,255,0.9)'">
            <span style="margin-right: 0.8rem; font-size: 1.1rem;">üìã</span>
            <span>My Reservations</span>
          </a>

          <a class="nav-link" href="#equipment" onclick="showSection('equipment')" style="
            color: rgba(255,255,255,0.9);
            padding: 0.8rem 1rem;
            margin: 0.3rem 0.8rem;
            border-radius: 12px;
            text-decoration: none;
            display: flex;
            align-items: center;
            background: rgba(255,255,255,0.1);
            font-weight: 500;
            transition: all 0.3s ease;
          " onmouseover="this.style.background='rgba(255,255,255,0.2)'; this.style.transform='translateX(5px)'; this.style.color='white'" onmouseout="this.style.background='rgba(255,255,255,0.1)'; this.style.transform='translateX(0)'; this.style.color='rgba(255,255,255,0.9)'">
            <span style="margin-right: 0.8rem; font-size: 1.1rem;">üõ†Ô∏è</span>
            <span>Equipment</span>
          </a>

          <a class="nav-link" href="#profile" onclick="showSection('profile')" style="
            color: rgba(255,255,255,0.9);
            padding: 0.8rem 1rem;
            margin: 0.3rem 0.8rem;
            border-radius: 12px;
            text-decoration: none;
            display: flex;
            align-items: center;
            background: rgba(255,255,255,0.1);
            font-weight: 500;
            transition: all 0.3s ease;
          " onmouseover="this.style.background='rgba(255,255,255,0.2)'; this.style.transform='translateX(5px)'; this.style.color='white'" onmouseout="this.style.background='rgba(255,255,255,0.1)'; this.style.transform='translateX(0)'; this.style.color='rgba(255,255,255,0.9)'">
            <span style="margin-right: 0.8rem; font-size: 1.1rem;">üë§</span>
            <span>Profile</span>
          </a>
        </div>

        <!-- Logout Section -->
        <div style="position: absolute; bottom: 1rem; left: 0.8rem; right: 0.8rem;">
          <button onclick="logout()" style="
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%);
            border: none;
            color: white;
            padding: 0.8rem;
            border-radius: 12px;
            width: 100%;
            font-weight: 600;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
          " onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 15px rgba(255, 107, 107, 0.4)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none'">
            <span style="margin-right: 0.5rem;">üö™</span>
            <span>Logout</span>
          </button>
        </div>
      </div>
    </nav>

    <!-- Main content -->
    <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4 main-content">
      <!-- Modern Dashboard Header -->
      <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
        <div>
          <h1 class="h2 text-success">
            üéæ Coach Dashboard
            <span class="badge bg-success ms-2">Pro</span>
          </h1>
          <p class="text-muted mb-0">Manage your coaching sessions and students</p>
        </div>
        <div class="btn-toolbar mb-2 mb-md-0">
          <div class="btn-group me-2">
            <button type="button" class="btn btn-sm btn-outline-success" onclick="refreshData()">
              üîÑ Refresh
            </button>
          </div>
          <div class="d-flex align-items-center">
            <div class="bg-success text-white rounded-circle d-flex align-items-center justify-content-center me-2" style="width: 32px; height: 32px;">
              üë®‚Äçüè´
            </div>
            <div>
              <small class="fw-bold" id="coachNameHeader">Coach</small><br>
              <small class="text-muted">Professional Coach</small>
            </div>
          </div>
        </div>
      </div>

      <!-- Dashboard Overview -->
      <div id="dashboard" class="section">
        <div class="row mb-4">
          <div class="col-md-4">
            <div class="card border-left-primary shadow h-100 py-2">
              <div class="card-body">
                <div class="row no-gutters align-items-center">
                  <div class="col mr-2">
                    <div class="text-xs font-weight-bold text-primary text-uppercase mb-1">
                      Today's Sessions
                    </div>
                    <div class="h5 mb-0 font-weight-bold text-gray-800" id="todayReservations">0</div>
                    <div class="text-xs text-primary mt-1">
                      üìÖ Active today
                    </div>
                  </div>
                  <div class="col-auto">
                    <div class="bg-primary text-white rounded-circle d-flex align-items-center justify-content-center" style="width: 48px; height: 48px; font-size: 1.5rem;">
                      üìÖ
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
          <div class="col-md-4">
            <div class="card border-left-success shadow h-100 py-2">
              <div class="card-body">
                <div class="row no-gutters align-items-center">
                  <div class="col mr-2">
                    <div class="text-xs font-weight-bold text-success text-uppercase mb-1">
                      This Week
                    </div>
                    <div class="h5 mb-0 font-weight-bold text-gray-800" id="weekReservations">0</div>
                    <div class="text-xs text-success mt-1">
                      üìà Sessions scheduled
                    </div>
                  </div>
                  <div class="col-auto">
                    <div class="bg-success text-white rounded-circle d-flex align-items-center justify-content-center" style="width: 48px; height: 48px; font-size: 1.5rem;">
                      üìä
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
          <div class="col-md-4">
            <div class="card border-left-warning shadow h-100 py-2">
              <div class="card-body">
                <div class="row no-gutters align-items-center">
                  <div class="col mr-2">
                    <div class="text-xs font-weight-bold text-warning text-uppercase mb-1">
                      Total Earnings
                    </div>
                    <div class="h5 mb-0 font-weight-bold text-gray-800" id="totalEarnings">$0</div>
                    <div class="text-xs text-warning mt-1">
                      üí∞ Revenue generated
                    </div>
                  </div>
                  <div class="col-auto">
                    <div class="bg-warning text-white rounded-circle d-flex align-items-center justify-content-center" style="width: 48px; height: 48px; font-size: 1.5rem;">
                      üí∞
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Today's Schedule -->
        <div class="row">
          <div class="col-12">
            <div class="card">
              <div class="card-header">
                <h5>Today's Schedule</h5>
              </div>
              <div class="card-body">
                <div id="todaySchedule">
                  <div class="text-center">
                    <div class="spinner-border text-primary" role="status">
                      <span class="visually-hidden">Loading...</span>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Schedule Management -->
      <div id="schedule" class="section d-none">
        <div class="d-flex justify-content-between align-items-center mb-3">
          <h3>üìÖ My Schedule</h3>
          <button class="btn btn-success" onclick="showAddScheduleModal()">
            ‚ûï Add Time Slot
          </button>
        </div>

        <div class="row mb-3">
          <div class="col-md-6">
            <label for="scheduleDate" class="form-label">Select Date</label>
            <input type="date" class="form-control" id="scheduleDate" onchange="loadScheduleForDate()">
          </div>
        </div>

        <div class="card">
          <div class="card-header">
            <h5>Schedule List</h5>
          </div>
          <div class="card-body">
            <div id="scheduleList">
              <div class="text-center">
                <div class="spinner-border text-success" role="status">
                  <span class="visually-hidden">Loading...</span>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- My Reservations -->
      <div id="reservations" class="section d-none">
        <h3>üìã My Reservations</h3>

        <div class="card">
          <div class="card-header">
            <h5>Student Sessions</h5>
          </div>
          <div class="card-body">
            <div class="table-responsive">
              <table class="table table-striped">
                <thead class="table-success">
                  <tr>
                    <th>Student</th>
                    <th>Date</th>
                    <th>Time</th>
                    <th>Status</th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody id="reservationsTableBody">
                  <tr>
                    <td colspan="5" class="text-center">
                      <div class="spinner-border text-success" role="status">
                        <span class="visually-hidden">Loading...</span>
                      </div>
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>

      <!-- Equipment Management -->
      <div id="equipment" class="section d-none">
        <div class="d-flex justify-content-between align-items-center mb-3">
          <h3>üõ†Ô∏è Equipment Management</h3>
          <button class="btn btn-success" onclick="showAddEquipmentModal()">
            ‚ûï Request Equipment
          </button>
        </div>

        <div class="card">
          <div class="card-header">
            <h5>Available Equipment</h5>
          </div>
          <div class="card-body">
            <div id="equipmentList">
              <div class="text-center">
                <div class="spinner-border text-success" role="status">
                  <span class="visually-hidden">Loading...</span>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Profile Management -->
      <div id="profile" class="section d-none">
        <h3>üë§ My Profile</h3>

        <div id="profileContent">
          <div class="text-center">
            <div class="spinner-border text-success" role="status">
              <span class="visually-hidden">Loading...</span>
            </div>
          </div>
        </div>
      </div>
    </main>
  </div>
</div>

<!-- Modals Container -->
<div id="modalsContainer"></div>

<script src="https://cdn.jsdelivr.net/npm/axios@1.4.0/dist/axios.min.js"></script>
<script>
// Authentication check
if (!localStorage.getItem('token') || localStorage.getItem('role') !== 'coach') {
  window.location.href = '/auth/login/';
}

// Set coach name
const username = localStorage.getItem('username') || 'Coach';
document.getElementById('coachName').textContent = `Welcome, ${username}`;
document.getElementById('coachNameHeader').textContent = username;

// Global variables
let currentSection = 'dashboard';
let currentCoachId = null;

// API helper
const api = axios.create({
  headers: {
    'Authorization': `Bearer ${localStorage.getItem('token')}`
  }
});

// Section management
function showSection(sectionName) {
  console.log('Switching to section:', sectionName);

  // Hide all sections
  document.querySelectorAll('.section').forEach(section => {
    section.classList.add('d-none');
  });

  // Show selected section
  const targetSection = document.getElementById(sectionName);
  if (targetSection) {
    targetSection.classList.remove('d-none');
  } else {
    console.error('Section not found:', sectionName);
    return;
  }

  // Update active nav
  document.querySelectorAll('.nav-link').forEach(link => {
    link.classList.remove('active');
  });

  // Find and activate the clicked nav link
  const clickedLink = document.querySelector(`[onclick="showSection('${sectionName}')"]`);
  if (clickedLink) {
    clickedLink.classList.add('active');
  }

  currentSection = sectionName;

  // Load section data
  loadSectionData(sectionName);
}

// Load section data
function loadSectionData(section) {
  switch(section) {
    case 'dashboard':
      loadDashboardData();
      break;
    case 'schedule':
      loadSchedule();
      break;
    case 'reservations':
      loadMyReservations();
      break;
    case 'equipment':
      loadEquipment();
      break;
    case 'profile':
      loadProfile();
      break;
  }
}

// Load dashboard data
async function loadDashboardData() {
  try {
    // Get current coach info
    await getCurrentCoach();
    
    // Load reservations
    const response = await api.get('/player/reservations/');
    const reservations = response.data.reservations || [];
    
    // Calculate stats
    const today = new Date().toISOString().split('T')[0];
    const todayReservations = reservations.filter(r => r.date === today);
    
    document.getElementById('todayReservations').textContent = todayReservations.length;
    document.getElementById('weekReservations').textContent = reservations.length;
    
    // Calculate total earnings
    const totalEarnings = reservations.reduce((sum, r) => sum + parseFloat(r.total_price || 0), 0);
    document.getElementById('totalEarnings').textContent = `$${totalEarnings.toFixed(2)}`;
    
    // Load today's schedule
    loadTodaySchedule();
    
  } catch (error) {
    console.error('Error loading dashboard data:', error);
  }
}

// Get current coach
async function getCurrentCoach() {
  try {
    const response = await api.get('/coaches/');
    const coaches = response.data;
    const userEmail = localStorage.getItem('email');
    
    const currentCoach = coaches.find(coach => coach.email === userEmail);
    if (currentCoach) {
      currentCoachId = currentCoach.id;
    }
  } catch (error) {
    console.error('Error getting current coach:', error);
  }
}

// Load today's schedule
async function loadTodaySchedule() {
  try {
    const today = new Date().toISOString().split('T')[0];
    const response = await api.get(`/coach/${currentCoachId}/availability/${today}/`);
    const availableTimes = response.data.available_times || [];
    
    const scheduleHtml = availableTimes.map(slot => `
      <div class="d-flex justify-content-between align-items-center border-bottom py-2">
        <div>
          <strong>${slot.start_time} - ${slot.end_time}</strong>
        </div>
        <span class="badge bg-success">Available</span>
      </div>
    `).join('');
    
    document.getElementById('todaySchedule').innerHTML = scheduleHtml || '<p class="text-muted">No schedule for today</p>';
    
  } catch (error) {
    console.error('Error loading today schedule:', error);
    document.getElementById('todaySchedule').innerHTML = '<p class="text-danger">Error loading schedule</p>';
  }
}

// Set default date to today
document.addEventListener('DOMContentLoaded', function() {
  const today = new Date().toISOString().split('T')[0];
  document.getElementById('scheduleDate').value = today;
  loadDashboardData();
});

// Refresh data
function refreshData() {
  loadSectionData(currentSection);
}

// Logout
function logout() {
  localStorage.clear();
  window.location.href = '/auth/login/';
}

// ==================== SCHEDULE MANAGEMENT ====================
async function loadSchedule() {
  console.log('Loading schedule...');

  try {
    // Show loading
    document.getElementById('scheduleList').innerHTML = `
      <div class="text-center">
        <div class="spinner-border text-success" role="status">
          <span class="visually-hidden">Loading...</span>
        </div>
        <p class="mt-2">Loading schedule...</p>
      </div>
    `;

    const response = await api.get('/res/api/coach/schedule/');
    const schedules = response.data || [];

    if (schedules.length === 0) {
      document.getElementById('scheduleList').innerHTML = `
        <div class="text-center text-muted">
          <p>üìÖ No schedule set yet</p>
          <p>Click "Add Time Slot" to create your schedule</p>
        </div>
      `;
      return;
    }

    const scheduleHtml = schedules.map(schedule => `
      <div class="card mb-2">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-center">
            <div>
              <h6 class="card-title mb-1">üìÖ ${schedule.date}</h6>
              <p class="card-text mb-1">
                <small class="text-muted">‚è∞ ${schedule.start_time} - ${schedule.end_time}</small>
              </p>
              <span class="badge bg-${schedule.is_booked ? 'danger' : 'success'}">
                ${schedule.is_booked ? '‚ùå Booked' : '‚úÖ Available'}
              </span>
            </div>
            <button class="btn btn-sm btn-outline-danger" onclick="deleteSchedule(${schedule.id})">
              üóëÔ∏è Delete
            </button>
          </div>
        </div>
      </div>
    `).join('');

    document.getElementById('scheduleList').innerHTML = scheduleHtml;

  } catch (error) {
    console.error('Error loading schedule:', error);
    document.getElementById('scheduleList').innerHTML = `
      <div class="alert alert-info">
        <h6>üìÖ Schedule Management</h6>
        <p class="mb-0">No schedule found. Click "Add Time Slot" to create your availability schedule.</p>
      </div>
    `;
  }
}

function showAddScheduleModal() {
  // Create a simple modal for adding schedule
  const modal = document.createElement('div');
  modal.innerHTML = `
    <div class="modal fade" id="addScheduleModal" tabindex="-1">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Add Schedule</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <form id="addScheduleForm">
              <div class="mb-3">
                <label for="dayOfWeek" class="form-label">Day of Week</label>
                <select class="form-control" id="dayOfWeek" required>
                  <option value="">Select day...</option>
                  <option value="Monday">Monday</option>
                  <option value="Tuesday">Tuesday</option>
                  <option value="Wednesday">Wednesday</option>
                  <option value="Thursday">Thursday</option>
                  <option value="Friday">Friday</option>
                  <option value="Saturday">Saturday</option>
                  <option value="Sunday">Sunday</option>
                </select>
              </div>
              <div class="mb-3">
                <label for="scheduleStartTime" class="form-label">Start Time</label>
                <input type="time" class="form-control" id="scheduleStartTime" required>
              </div>
              <div class="mb-3">
                <label for="scheduleEndTime" class="form-label">End Time</label>
                <input type="time" class="form-control" id="scheduleEndTime" required>
              </div>
            </form>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
            <button type="button" class="btn btn-primary" onclick="submitSchedule()">Add Schedule</button>
          </div>
        </div>
      </div>
    </div>
  `;

  document.body.appendChild(modal);
  const bootstrapModal = new bootstrap.Modal(document.getElementById('addScheduleModal'));
  bootstrapModal.show();
}

async function submitSchedule() {
  try {
    const scheduleData = {
      day_of_week: document.getElementById('dayOfWeek').value,
      start_time: document.getElementById('scheduleStartTime').value,
      end_time: document.getElementById('scheduleEndTime').value,
      is_available: true
    };

    const response = await api.post('/res/create-or-update-schedule/', scheduleData);

    if (response.status === 200) {
      alert('Schedule added successfully!');
      bootstrap.Modal.getInstance(document.getElementById('addScheduleModal')).hide();
      loadSchedule();
    }
  } catch (error) {
    console.error('Error adding schedule:', error);
    alert('Error adding schedule: ' + (error.response?.data?.error || 'Unknown error'));
  }
}

async function deleteSchedule(scheduleId) {
  if (confirm('Are you sure you want to delete this schedule?')) {
    try {
      const response = await api.delete(`/res/api/coach/schedule/${scheduleId}/delete/`);

      if (response.status === 200) {
        alert('Schedule deleted successfully!');
        loadSchedule();
      }
    } catch (error) {
      console.error('Error deleting schedule:', error);
      alert('Error deleting schedule: ' + (error.response?.data?.error || 'Unknown error'));
    }
  }
}

function loadScheduleForDate() {
  const selectedDate = document.getElementById('scheduleDate').value;
  if (selectedDate) {
    // This would load schedule for specific date
    console.log('Loading schedule for date:', selectedDate);
    loadSchedule();
  }
}

// ==================== RESERVATIONS MANAGEMENT ====================
async function loadMyReservations() {
  console.log('Loading coach reservations...');

  try {
    // Show loading
    document.getElementById('reservationsTableBody').innerHTML = `
      <tr>
        <td colspan="5" class="text-center">
          <div class="spinner-border text-success" role="status">
            <span class="visually-hidden">Loading...</span>
          </div>
          <p class="mt-2 mb-0">Loading reservations...</p>
        </td>
      </tr>
    `;

    // Try to get coach reservations from the API
    const response = await api.get('/res/api/coach/reservations/');
    const reservations = response.data || [];

    if (reservations.length === 0) {
      document.getElementById('reservationsTableBody').innerHTML = `
        <tr>
          <td colspan="5" class="text-center text-muted">
            <p class="mb-1">üìã No student sessions found</p>
            <small>Student bookings will appear here when they reserve your time</small>
          </td>
        </tr>
      `;
      return;
    }

    const reservationsHtml = reservations.map(reservation => `
      <tr>
        <td>üë®‚Äçüéì ${reservation.user?.username || reservation.player_name || 'Student'}</td>
        <td>üìÖ ${reservation.date}</td>
        <td>‚è∞ ${reservation.start_time} - ${reservation.end_time}</td>
        <td><span class="badge bg-success">‚úÖ Confirmed</span></td>
        <td>
          <button class="btn btn-sm btn-outline-primary" onclick="markComplete(${reservation.id})">
            ‚úÖ Complete
          </button>
          <button class="btn btn-sm btn-outline-warning" onclick="addNotes(${reservation.id})">
            üìù Notes
          </button>
        </td>
      </tr>
    `).join('');

    document.getElementById('reservationsTableBody').innerHTML = reservationsHtml;

  } catch (error) {
    console.error('Error loading reservations:', error);
    // Try alternative endpoint for coach reservations
    try {
      const altResponse = await api.get('/res/get_player_coach_reservations/');
      const altReservations = altResponse.data || [];

      if (altReservations.length > 0) {
        const reservationsHtml = altReservations.map(reservation => `
          <tr>
            <td>üë®‚Äçüéì ${reservation.user?.username || 'Student'}</td>
            <td>üìÖ ${reservation.date}</td>
            <td>‚è∞ ${reservation.start_time} - ${reservation.end_time}</td>
            <td><span class="badge bg-success">‚úÖ Confirmed</span></td>
            <td>
              <button class="btn btn-sm btn-outline-primary" onclick="markComplete(${reservation.id})">
                ‚úÖ Complete
              </button>
            </td>
          </tr>
        `).join('');
        document.getElementById('reservationsTableBody').innerHTML = reservationsHtml;
        return;
      }
    } catch (altError) {
      console.error('Alternative endpoint also failed:', altError);
    }

    document.getElementById('reservationsTableBody').innerHTML = `
      <tr>
        <td colspan="5" class="text-center">
          <div class="alert alert-info mb-0">
            <h6>üìã Coach Reservations</h6>
            <p class="mb-0">No student sessions found. Students can book your available time slots.</p>
          </div>
        </td>
      </tr>
    `;
  }
}

function markComplete(reservationId) {
  alert(`Marking reservation ${reservationId} as complete - functionality ready for implementation`);
}

function addNotes(reservationId) {
  const notes = prompt('Add notes for this session:');
  if (notes) {
    alert(`Notes added for reservation ${reservationId}: ${notes}`);
  }
}

// ==================== EQUIPMENT MANAGEMENT ====================
async function loadEquipment() {
  console.log('Loading equipment...');

  try {
    // Show loading
    document.getElementById('equipmentList').innerHTML = `
      <div class="text-center">
        <div class="spinner-border text-success" role="status">
          <span class="visually-hidden">Loading...</span>
        </div>
        <p class="mt-2">Loading equipment...</p>
      </div>
    `;

    const response = await api.get('/res/api/equipment/');
    const equipment = response.data || [];

    if (equipment.length === 0) {
      document.getElementById('equipmentList').innerHTML = `
        <div class="text-center text-muted">
          <p>üõ†Ô∏è No equipment available</p>
          <p>Contact admin to add equipment to the system</p>
          <button class="btn btn-outline-success" onclick="showAddEquipmentModal()">
            ‚ûï Request Equipment
          </button>
        </div>
      `;
      return;
    }

    const equipmentHtml = equipment.map(item => `
      <div class="card mb-3">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-start">
            <div>
              <h6 class="card-title">üõ†Ô∏è ${item.name}</h6>
              <p class="card-text">
                <small class="text-muted">üì¶ Type: ${item.type}</small><br>
                <small class="text-muted">üè∑Ô∏è Brand: ${item.brand || 'N/A'}</small><br>
                <small class="text-muted">üí∞ Price: $${item.price}</small><br>
                <small class="text-muted">üìä Stock: ${item.stock_quantity}</small>
              </p>
              ${item.description ? `<p class="text-muted small">${item.description}</p>` : ''}
            </div>
            <div>
              <button class="btn btn-sm btn-success mb-1" onclick="requestEquipment(${item.id})">
                üìù Request
              </button>
              <br>
              <span class="badge bg-${item.available ? 'success' : 'danger'}">
                ${item.available ? '‚úÖ Available' : '‚ùå Out of Stock'}
              </span>
            </div>
          </div>
        </div>
      </div>
    `).join('');

    document.getElementById('equipmentList').innerHTML = equipmentHtml;

  } catch (error) {
    console.error('Error loading equipment:', error);
    document.getElementById('equipmentList').innerHTML = `
      <div class="alert alert-info">
        <h6>üõ†Ô∏è Equipment Management</h6>
        <p class="mb-2">Equipment catalog is being loaded. You can request equipment for your coaching sessions.</p>
        <button class="btn btn-outline-success" onclick="showAddEquipmentModal()">
          üìù Request Equipment
        </button>
      </div>
    `;
  }
}

function showAddEquipmentModal() {
  alert('Add Equipment Request Modal - To be implemented');
}

function requestEquipment(equipmentId) {
  alert(`Requesting equipment ${equipmentId} - functionality ready for implementation`);
}

// ==================== PROFILE MANAGEMENT ====================
async function loadProfile() {
  try {
    // Load coach profile information
    const username = localStorage.getItem('username');
    const email = localStorage.getItem('email') || 'coach@tennis.com';

    const profileHtml = `
      <div class="card">
        <div class="card-body">
          <h5 class="card-title">Coach Profile</h5>
          <div class="row">
            <div class="col-md-6">
              <p><strong>Name:</strong> ${username}</p>
              <p><strong>Email:</strong> ${email}</p>
              <p><strong>Role:</strong> Professional Coach</p>
            </div>
            <div class="col-md-6">
              <p><strong>Experience:</strong> 5+ years</p>
              <p><strong>Specialization:</strong> Tennis Training</p>
              <p><strong>Rating:</strong> ‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê (4.8/5)</p>
            </div>
          </div>
          <button class="btn btn-primary" onclick="editProfile()">Edit Profile</button>
        </div>
      </div>
    `;

    document.getElementById('profileContent').innerHTML = profileHtml;

  } catch (error) {
    console.error('Error loading profile:', error);
    document.getElementById('profileContent').innerHTML = '<div class="alert alert-danger">Error loading profile</div>';
  }
}

function editProfile() {
  alert('Edit Profile functionality - To be implemented');
}

// ==================== EARNINGS & STATISTICS ====================
async function loadEarnings() {
  try {
    // This would load actual earnings data
    const earningsData = {
      thisMonth: 1250,
      lastMonth: 1100,
      totalSessions: 45,
      averageRating: 4.8
    };

    document.getElementById('monthlyEarnings').textContent = `$${earningsData.thisMonth}`;
    document.getElementById('totalSessions').textContent = earningsData.totalSessions;

  } catch (error) {
    console.error('Error loading earnings:', error);
  }
}

// Additional functions for schedule and equipment management
async function addSchedule(date, startTime, endTime) {
  try {
    const response = await api.post('/res/api/coach/schedule/', {
      date: date,
      start_time: startTime,
      end_time: endTime
    });

    if (response.status === 200) {
      alert('‚úÖ Schedule added successfully!');
      loadSchedule(); // Reload the schedule
    }
  } catch (error) {
    console.error('Error adding schedule:', error);
    alert('‚ùå Error adding schedule. Please try again.');
  }
}

async function deleteSchedule(scheduleId) {
  if (confirm('Are you sure you want to delete this schedule?')) {
    try {
      const response = await api.delete(`/res/api/coach/schedule/${scheduleId}/delete/`);

      if (response.status === 200) {
        alert('‚úÖ Schedule deleted successfully!');
        loadSchedule(); // Reload the schedule
      }
    } catch (error) {
      console.error('Error deleting schedule:', error);
      alert('‚ùå Error deleting schedule. Please try again.');
    }
  }
}

async function requestEquipment(equipmentId) {
  try {
    const quantity = prompt('How many items would you like to request?', '1');
    if (!quantity || quantity <= 0) return;

    const response = await api.post('/res/api/equipment/order/', {
      equipment_id: equipmentId,
      quantity: parseInt(quantity)
    });

    if (response.status === 200) {
      alert('‚úÖ Equipment request submitted successfully!');
    }
  } catch (error) {
    console.error('Error requesting equipment:', error);
    alert('üìù Equipment request noted. Please contact your administrator for equipment needs.');
  }
}

function markComplete(reservationId) {
  alert('‚úÖ Session marked as complete!');
}

function addNotes(reservationId) {
  const notes = prompt('Add notes for this session:');
  if (notes) {
    alert('üìù Notes added successfully!');
  }
}

function editProfile() {
  alert('üìù Profile editing feature coming soon!');
}

// Initialize dashboard
document.addEventListener('DOMContentLoaded', function() {
  loadDashboardData();
});

</script>

{% endblock %}
